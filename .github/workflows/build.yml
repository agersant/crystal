name: Build

on:
  pull_request:
  push:

jobs:
  tests-windows:
    name: Run Tests (Windows)
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install Love 2D
      run:  |
        curl -L -o love.zip https://bitbucket.org/rude/love/downloads/love-11.3-win64.zip
        unzip love.zip
        echo "##[add-path]${{ github.workspace }}\love-11.3-win64"
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        default: true
    - name: Build Diamond
      run: .\build_diamond_windows.ps1
    - name: Run Diamond tests
      run: cargo test --release
      working-directory: ./lib/diamond
    - name: Run Crystal Tests
      run: lovec . /test /coverage
      working-directory: ./game

  tests-linux:
    name: Run Tests (Linux)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install Love 2D
      run:  |
        curl -L -o love https://bitbucket.org/rude/love/downloads/love-11.3-x86_64.AppImage
        chmod +x love
        echo "::add-path::${{ github.workspace }}"
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        default: true
    - name: Install Tarpaulin
      run: cargo install cargo-tarpaulin
    - name: Build Diamond
      run: ./build_diamond_linux.sh
    - name: Run Diamond tests
      run: cargo tarpaulin --ignore-tests --out Xml -t 600
      working-directory: ./lib/diamond
    - name: Run Crystal Tests
      run: love . /test /coverage
      working-directory: ./game
    - name: Upload Test Coverage Results
      uses: codecov/codecov-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
